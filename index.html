<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IP Saver - Firebase</title>
  <style>
    body{font-family:system-ui,Arial;max-width:720px;margin:30px auto;padding:10px}
    label{display:block;margin-top:12px}
    input{width:100%;padding:8px;margin-top:6px}
    button{margin-top:12px;padding:8px 12px}
    .note{color:#555;font-size:0.9rem;margin-top:10px}
  </style>
</head>
<body>
  <h2>IP Auto-Save Demo</h2>

  <label>Current IP
    <input id="current-ip" readonly placeholder="Detecting...">
  </label>

  <label>Previous IP (from Firebase)
    <input id="previous-ip" readonly placeholder="---">
  </label>

  <div class="note">
    Auto-detects public IP using <b>api.ipify.org</b> and saves it to <b>Firestore</b>.<br>
    Uses <b>Anonymous Auth</b> for safe writes.
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    // üîπ Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBSl7Hdc20zarK_KHFNgmSrMCiDqMF6oiI",
      authDomain: "ipv4-checker.firebaseapp.com",
      projectId: "ipv4-checker",
      storageBucket: "ipv4-checker.firebasestorage.app",
      messagingSenderId: "568806408801",
      appId: "1:568806408801:web:d0de4b2c0e91f8cb27e020",
      measurementId: "G-MEGYZCN3WS"
    };

    // üîπ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const currentIpInput = document.getElementById('current-ip');
    const previousIpInput = document.getElementById('previous-ip');

    // Fetch public IP
    async function fetchMyIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        return data.ip;
      } catch (err) {
        console.error("‚ùå Failed to fetch IP:", err);
        return null;
      }
    }

    // Read latest IP from Firestore
    async function readLatestIP() {
      const ref = doc(db, 'settings', 'latestIP');
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data().ip : null;
    }

    // Save IP to Firestore
    async function saveIPToFirestore(ip) {
      const ref = doc(db, 'settings', 'latestIP');
      await setDoc(ref, { ip, updatedAt: serverTimestamp() });
      console.log("‚úÖ IP saved:", ip);
    }

    // üîπ Main logic
    window.addEventListener('DOMContentLoaded', async () => {
      // 1. Show previously saved IP
      const prev = await readLatestIP();
      if (prev) previousIpInput.value = prev;

      // 2. Anonymous Auth login
      try {
        await signInAnonymously(auth);
        console.log("‚úÖ Signed in anonymously");
      } catch (e) {
        console.error("‚ùå Anonymous sign-in failed:", e);
      }

      // 3. Fetch current IP and save to Firestore
      const ip = await fetchMyIP();
      if (ip) {
        currentIpInput.value = ip;
        await saveIPToFirestore(ip);
        // Refresh previous IP
        const latest = await readLatestIP();
        if (latest) previousIpInput.value = latest;
      } else {
        currentIpInput.value = "Could not detect IP";
      }
    });
  </script>
</body>
</html>
