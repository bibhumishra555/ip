<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IP saver - Firebase</title>
  <style>
    body{font-family:system-ui,Arial;max-width:720px;margin:30px auto;padding:10px}
    label{display:block;margin-top:12px}
    input{width:100%;padding:8px;margin-top:6px}
    button{margin-top:12px;padding:8px 12px}
    .note{color:#555;font-size:0.9rem;margin-top:10px}
  </style>
</head>
<body>
  <h2>IP auto-save demo</h2>

  <label>Current IP
    <input id="current-ip" readonly placeholder="Detecting...">
  </label>

  <label>Previous IP (from server)
    <input id="previous-ip" readonly placeholder="---">
  </label>

  <div class="note">
    Auto-detects public IP using api.ipify.org and saves latest value to Firestore.<br>
    Uses anonymous Firebase auth so only authenticated clients may write.
  </div>

  <script type="module">
    // Import Firebase SDK modules (v12.5.0)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    console.log('ğŸ”¥ Firebase SDK modules loaded successfully');

    // --- Replace with your Firebase config from Console ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com", 
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    // ----------------------------------------------------

    // Initialize Firebase
    console.log('ğŸš€ Initializing Firebase...');
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    console.log('âœ… Firebase initialized successfully');

    const currentIpInput = document.getElementById('current-ip');
    const previousIpInput = document.getElementById('previous-ip');

    // Fetch user's public IP address
    async function fetchMyIP() {
      console.log('ğŸŒ Fetching public IP address...');
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        console.log('âœ… Successfully fetched IP:', data.ip);
        return data.ip;
      } catch (error) {
        console.error('âŒ Failed to fetch IP address:', error);
        return null;
      }
    }

    // Read latest IP from Firestore (document path: settings/latestIP)
    async function readLatestIP() {
      console.log('ğŸ“– Reading previous IP from Firestore...');
      try {
        const docRef = doc(db, 'settings', 'latestIP');
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          const previousIP = data.ip || null;
          console.log('âœ… Successfully read previous IP:', previousIP);
          return previousIP;
        } else {
          console.log('â„¹ï¸ No previous IP found in Firestore');
          return null;
        }
      } catch (error) {
        console.error('âŒ Failed to read previous IP from Firestore:', error);
        return null;
      }
    }

    // Save IP to Firestore (requires authentication)
    async function saveIPToFirestore(ip) {
      console.log('ğŸ’¾ Saving IP to Firestore:', ip);
      try {
        const docRef = doc(db, 'settings', 'latestIP');
        await setDoc(docRef, { 
          ip: ip, 
          updatedAt: serverTimestamp(),
          timestamp: new Date().toISOString()
        });
        console.log('âœ… Successfully saved IP to Firestore');
      } catch (error) {
        console.error('âŒ Failed to save IP to Firestore:', error);
        throw error;
      }
    }

    // Main application flow
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ”„ Page loaded, starting IP detection and sync process...');

      try {
        // Step 1: Read previous IP from Firestore first (fast UI update)
        console.log('ğŸ“‹ Step 1: Reading previous IP...');
        const previousIP = await readLatestIP();
        if (previousIP) {
          previousIpInput.value = previousIP;
          console.log('âœ… Step 1 complete: Previous IP displayed');
        } else {
          previousIpInput.value = 'No previous IP found';
          console.log('â„¹ï¸ Step 1 complete: No previous IP to display');
        }

        // Step 2: Enable anonymous authentication
        console.log('ğŸ” Step 2: Signing in anonymously...');
        try {
          await signInAnonymously(auth);
          console.log('âœ… Step 2 complete: Anonymous authentication successful');
        } catch (authError) {
          console.error('âŒ Step 2 failed: Anonymous sign-in error:', authError);
          console.log('âš ï¸ Continuing without authentication - writes may fail');
        }

        // Step 3: Fetch current IP and update UI
        console.log('ğŸ” Step 3: Fetching current IP...');
        const currentIP = await fetchMyIP();
        
        if (currentIP) {
          currentIpInput.value = currentIP;
          console.log('âœ… Step 3 complete: Current IP displayed');

          // Step 4: Auto-save current IP to Firestore
          console.log('ğŸ’¾ Step 4: Auto-saving current IP...');
          try {
            await saveIPToFirestore(currentIP);
            console.log('âœ… Step 4 complete: Current IP saved to Firestore');

            // Step 5: Refresh previous IP display (in case it changed)
            console.log('ğŸ”„ Step 5: Refreshing previous IP display...');
            const latestIP = await readLatestIP();
            if (latestIP) {
              previousIpInput.value = latestIP;
              console.log('âœ… Step 5 complete: Previous IP display updated');
            }
          } catch (saveError) {
            console.error('âŒ Step 4 failed: Could not save IP to Firestore:', saveError);
          }
        } else {
          currentIpInput.value = 'Could not detect IP';
          console.log('âŒ Step 3 failed: Unable to detect current IP');
        }

        console.log('ğŸ‰ IP detection and sync process completed!');

      } catch (error) {
        console.error('ğŸ’¥ Critical error in main process:', error);
        currentIpInput.value = 'Error occurred';
      }
    });
  </script>
</body>
</html>

